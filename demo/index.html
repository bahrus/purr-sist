<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>
    <div style="display:flex;flex-direction: column">
        <xtal-state-parse disabled parse="location.href" level="global" 
            with-url-pattern="id=(?<storeId>[a-z0-9-]*)">
        </xtal-state-parse>
        <p-d on="no-match" to="purr-sist[write]{new:target.noMatch}"  m="1"></p-d>
        <p-d on="value-changed" to="purr-sist{storeId:target.value.storeId}" m="2"></p-d>
        <purr-sist read></purr-sist>
        <p-d on="value-changed" to="xtal-state-update{history:target.value}"></p-d>
        <input type="text" placeholder="key">
        <p-d on="input" to="aggregator-fn{key:target.value}" m="1"></p-d>
        <textarea placeholder="value (JSON optional)"></textarea>
        <p-d on="input" to="{val:target.value}"></p-d>
        <aggregator-fn><script nomodule>
            ({ key, val }) => {
                if (key === undefined || val === undefined) return null;
                try {
                    return { [key]: JSON.parse(val) };
                } catch (e) {
                    return { [key]: val };
                }
            }
        </script></aggregator-fn>
        <p-d on="value-changed" to="{obj:target.value}"></p-d>
        <button>Insert Key/Value pair</button>
        <p-d on="click" to="xtal-state-update{history:target.obj}" skip-init></p-d>

        <xtal-state-update rewrite level="global" url-search="(?<store>(.*?))" replace-url-value="?id=$<store>"></xtal-state-update>
        <p-d on="history-changed" to="{historyEvent:target}" skip-init></p-d>   
        <purr-sist write></purr-sist>
        <p-d on="value-changed" to="{input}"></p-d>
        <xtal-json-editor options="{}" height="300px"></xtal-json-editor>
        <button onclick="window.location.reload()">Reload Window</button>


        <!-- <script type="module" src="https://cdn.jsdelivr.net/npm/purr-sist@0.0.11/purr-sist.iife.js"></script> -->
        <script type="module" src="../purr-sist.js"></script>
        <!-- <script type="module" src="https://cdn.jsdelivr.net/npm/pass-down@0.0.10/pass-down.iife.js"></script> -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/p-d.p-u@0.0.69/p-d.p-d-x.p-u.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/xtal-json-editor@0.0.29/xtal-json-editor.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/aggregator-fn@0.0.11/aggregator-fn.iife.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/xtal-state@0.0.34/xtal-state.js"></script>
    </div>
</body>

</html>