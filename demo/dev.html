<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div data-pd style="display:flex;flex-direction: column">
        <pass-down></pass-down>
        <input type="text" placeholder="key" data-on="input: pass-to:aggregator-fn{key:target.value}{1}">
        <textarea placeholder="value (JSON optional)" data-on="input: pass-to:aggregator-fn{val:target.value}{1}"></textarea>
        <aggregator-fn data-on="value-changed: pass-to-next:{obj:target.value}">
            <script nomodule>
                ({ key, val }) => {
                    if (key === undefined || val === undefined) return null;
                    if (val.startsWith('{') || val.startsWith('[')) {
                        try{
                            return { [key]: JSON.parse(val) };
                        }catch(e){
                            return null;
                        }
                        
                    }
                    return { [key]: val };
                }
            </script>
        </aggregator-fn>
        <button data-on="click: pass-to:purr-sist{newVal:target.obj} skip-init">Insert Key/Value pair</button>
        <purr-sist persist data-on="value-changed: pass-to-next:{input:target.value}
            store-id-changed: pass-to:xtal-state-commit{url:target.storeId;history:target.storeId}
        "></purr-sist>
        <xtal-json-editor options="{}" height="300px"></xtal-json-editor>
        <xtal-state-commit rewrite level="global" url-search="(?<store>(.*?))" replace-url-value="?id=$<store>" with-path="store-id"></xtal-state-commit>
        <button onclick="window.location.reload()">Reload Window</button>
        <!-- <script>
            const ps = document.querySelector('purr-sist');
            ps.addEventListener('value-changed', e => {
                window.history.replaceState(e.target.value, '', '?id=' + e.target.storeId);
            });
            const sp = new URLSearchParams(location.search);
            const storeId = sp.get('id');
            if (storeId) {
                ps.storeId = storeId;
            }
            ps.persist = true;
        </script> -->
        <script type="module" src="../purr-sist.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/pass-down@0.0.10/pass-down.iife.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/xtal-json-editor@0.0.29/xtal-json-editor.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/aggregator-fn@0.0.11/aggregator-fn.iife.js"></script>
        <script type="module" src="https://cdn.jsdelivr.net/npm/xtal-state@0.0.26/xtal-state.js"></script>
    </div>
</body>
</html>