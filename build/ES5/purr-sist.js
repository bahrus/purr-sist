import{XtallatX,disabled}from"./node_modules/xtal-latx/xtal-latx.js";import{define}from"./node_modules/xtal-latx/define.js";import{BaseLinkId}from"./node_modules/xtal-latx/base-link-id.js";var store_id="store-id",save_service_url="save-service-url",persist="persist",create="create",guid="guid",master_list_id="master-list-id";export var PurrSist=function(_BaseLinkId){babelHelpers.inherits(PurrSist,_BaseLinkId);function PurrSist(){var _this;babelHelpers.classCallCheck(this,PurrSist);_this=babelHelpers.possibleConstructorReturn(this,(PurrSist.__proto__||Object.getPrototypeOf(PurrSist)).apply(this,arguments));_this._initInProgress=!1;return _this}babelHelpers.createClass(PurrSist,[{key:"attributeChangedCallback",value:function attributeChangedCallback(n,ov,nv){console.log(n);babelHelpers.get(PurrSist.prototype.__proto__||Object.getPrototypeOf(PurrSist.prototype),"attributeChangedCallback",this).call(this,n,ov,nv);switch(n){case store_id:this._storeId=nv;this.de("store-id",{value:nv});break;case save_service_url:this._saveServiceUrl=nv;break;case master_list_id:this._masterListId=nv;break;case guid:this._guid=nv;break;case create:case persist:this["_"+n]=null!==nv;break;}this.onPropsChange()}},{key:"syncMasterList",value:function syncMasterList(){var _this2=this;if(!this._masterListId||!this._guid)return;var master=this.getMaster();if(!master||!master.value){setTimeout(function(){_this2.syncMasterList()},50);return}if(master.value[this._guid]===void 0){master.newVal=babelHelpers.defineProperty({},this._guid,this._storeId)}}},{key:"pullRecFromMaster",value:function pullRecFromMaster(master){if(master.value[this._guid]===void 0){this.createNew(master)}else{this.storeId=master.value[this._guid]}}},{key:"createNew",value:function createNew(master){var _this3=this;if(this._initInProgress)return;fetch(this._saveServiceUrl,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"POST",body:JSON.stringify({})}).then(function(resp){resp.json().then(function(json){_this3._initInProgress=!1;_this3.storeId=json.uri.split("/").pop();if(_this3._pendingNewVals){_this3._pendingNewVals.forEach(function(kvp){_this3.newVal=kvp});delete _this3._pendingNewVals}if(null!==master)master.newVal=babelHelpers.defineProperty({},_this3._guid,_this3._storeId)})})}},{key:"connectedCallback",value:function connectedCallback(){this._upgradeProperties(["storeId","saveServiceUrl",persist,create,disabled,guid,"masterListId"]);this.style.display="none";this._conn=!0;if(!this._saveServiceUrl){if(this._baseLinkId){this._saveServiceUrl=this.getFullURL("")}else{this._saveServiceUrl="https://api.myjson.com/bins"}}this.onPropsChange()}},{key:"setValue",value:function setValue(val){this.value=val;this.de("value",{value:val})}},{key:"getMaster",value:function getMaster(){if(!this._masterListId.startsWith("/"))throw"Must start with \"/\"";return self[this._masterListId.substr(1)]}},{key:"onPropsChange",value:function onPropsChange(){var _this4=this;if(!this._conn||!this._saveServiceUrl||this._disabled||!this._persist)return;if(!this._storeId){if(this._masterListId){var mst=this.getMaster();if(!mst||!mst.value){setTimeout(function(){_this4.onPropsChange()},50);return}this.pullRecFromMaster(mst)}else if(this._create){this.createNew(null)}}else{if(this._fip)return;this._fip=!0;fetch(this._saveServiceUrl+"/"+this._storeId).then(function(resp){resp.json().then(function(json){_this4.setValue(json);_this4._fip=!1})})}}},{key:"storeId",get:function get(){return this._storeId},set:function set(val){this._storeId=val;this.attr(store_id,val);this.syncMasterList()}},{key:"refresh",set:function set(){this.storeId=this._storeId}},{key:"saveServiceUrl",get:function get(){return this._saveServiceUrl},set:function set(val){this.attr(save_service_url,val)}},{key:"persist",get:function get(){return this._persist},set:function set(nv){this.attr(persist,nv,"")}},{key:"create",get:function get(){return this._create},set:function set(nv){this.attr(create,nv,"")}},{key:"guid",get:function get(){return this._guid},set:function set(nv){this.attr(guid,nv)}},{key:"masterListId",get:function get(){return this._masterListId},set:function set(nv){this.attr(master_list_id,nv)}},{key:"newVal",get:function get(){return this._newVal},set:function set(val){var _this5=this;if(null===val)return;if(!this._storeId){if(!this._pendingNewVals)this._pendingNewVals=[];this._pendingNewVals.push(val);return}this._newVal=val;var value=this.value===void 0?val:Object.assign(this.value,val);fetch(this._saveServiceUrl+"/"+this._storeId,{headers:{Accept:"application/json","Content-Type":"application/json"},method:"PUT",body:JSON.stringify(value)}).then(function(){_this5.setValue(value)})}}],[{key:"is",get:function get(){return"purr-sist"}},{key:"observedAttributes",get:function get(){return babelHelpers.get(PurrSist.__proto__||Object.getPrototypeOf(PurrSist),"observedAttributes",this).concat([store_id,save_service_url,persist,create,guid,master_list_id])}}]);return PurrSist}(BaseLinkId(XtallatX(HTMLElement)));define(PurrSist);