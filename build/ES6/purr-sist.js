import{XtallatX,disabled}from"./node_modules/xtal-latx/xtal-latx.js";import{BaseLinkId}from"./node_modules/xtal-latx/base-link-id.js";const store_id="store-id",write="write",read="read",new$="new",guid="guid",master_list_id="master-list-id";export class PurrSist extends BaseLinkId(XtallatX(HTMLElement)){constructor(){super(...arguments);this._initInProgress=!1}static get observedAttributes(){return super.observedAttributes.concat([store_id,write,read,new$,guid,master_list_id])}attributeChangedCallback(n,ov,nv){super.attributeChangedCallback(n,ov,nv);switch(n){case store_id:this._storeId=nv;this.de("store-id",{value:nv});break;case master_list_id:this._masterListId=nv;break;case guid:this._guid=nv;break;case new$:case write:case read:this["_"+n]=null!==nv;break;}this.onPropsChange(n)}get storeId(){return this._storeId}set storeId(val){this._storeId=val;this.attr(store_id,val);this.syncMasterList()}syncMasterList(){if(!this._masterListId||!this._guid)return;const master=this.getMaster();if(!master||!master.value){setTimeout(()=>{this.syncMasterList()},50);return}if(master.value[this._guid]===void 0){master.newVal={[this._guid]:this._storeId}}}pullRecFromMaster(master){if(master.value[this._guid]===void 0){if(this._write){this.createNew(master)}}else{this.storeId=master.value[this._guid]}}set refresh(val){this.storeId=this._storeId}get write(){return this._write}set write(nv){this.attr(write,nv,"")}get read(){return this._read}set read(nv){this.attr(read,nv,"")}get new(){return this._new}set new(nv){this.attr(new$,nv,"")}get guid(){return this._guid}set guid(nv){this.attr(guid,nv)}get masterListId(){return this._masterListId}set masterListId(nv){this.attr(master_list_id,nv)}set historyEvent(val){if(val.url!==this._storeId){val.url=this._storeId}const v=val.value;if(!v)return;if(v.__purrSistInit){delete v.__purrSistInit;this.value=v}else{this.newVal=val.value}}get newVal(){return this._newVal}set newVal(val){if(null===val)return;if(!this._storeId){if(!this._pendingNewVals)this._pendingNewVals=[];this._pendingNewVals.push(val);return}this._newVal=val;this.saveNewVal(val)}connectedCallback(){this._upgradeProperties(["storeId",write,read,new$,disabled,guid,"masterListId"]);this.style.display="none";this._conn=!0;this.onPropsChange()}get value(){return this._value}set value(val){this._value=val;this.de("value",{value:val})}getMaster(){if(!this._masterListId.startsWith("/"))throw"Must start with \"/\"";return self[this._masterListId.substr(1)]}onPropsChange(n){if(!this._conn||this._disabled)return;if(!this._storeId){if(this._masterListId){const mst=this.getMaster();if(!mst||!mst.value){setTimeout(()=>{this.onPropsChange()},50);return}this.pullRecFromMaster(mst)}else if(this._new&&this._write){this.createNew(null)}}else{if(this._write)return;this.getStore()}}}